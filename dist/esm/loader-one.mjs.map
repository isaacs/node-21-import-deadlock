{"version":3,"file":"loader-one.mjs","sourceRoot":"","sources":["../../src/loader-one.mts"],"names":[],"mappings":"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","sourcesContent":["import { LoadHook, ResolveHook } from 'node:module'\nimport { MessagePort } from 'node:worker_threads'\nimport { consoleError } from './console-error.mjs'\nimport { foo } from './shared.mjs'\n\nlet PENDING = 0\n\nlet PORT: undefined | MessagePort = undefined\n\nexport const initialize = ({ port }: { port: MessagePort }) => {\n  PORT = port\n}\n\nexport const load: LoadHook = async (url, context, nextLoad) => {\n  consoleError('loader 1 : load : start', url)\n  if (!PORT) throw new Error('not initialized')\n  const id = String(Math.random())\n  let resolve!: () => void\n  const p = new Promise<void>(r => (resolve = r))\n  const onMessage = (msg: any) => {\n    if (msg.id === id) PORT?.removeListener('message', onMessage)\n    PENDING--\n    resolve()\n  }\n  PENDING++\n  PORT.ref()\n  PORT.on('message', onMessage)\n  PORT.postMessage({\n    id,\n    foo,\n    url,\n    context,\n  })\n  await p\n  if (PENDING === 0) PORT.unref()\n  consoleError('loader 1 : load : returning nextLoad', url)\n  return nextLoad(url, context)\n}\n\nexport const resolve: ResolveHook = async (url, context, nextResolve) => {\n  consoleError('loader 1 : resolve : start', url)\n  if (!PORT) throw new Error('not initialized')\n  const id = String(Math.random())\n  let resolve!: () => void\n  const p = new Promise<void>(r => (resolve = r))\n  const onMessage = (msg: any) => {\n    if (msg.id === id) PORT?.removeListener('message', onMessage)\n    PENDING--\n    resolve()\n  }\n  PENDING++\n  PORT.ref()\n  PORT.on('message', onMessage)\n  PORT.postMessage({\n    id,\n    foo,\n    url,\n    context,\n  })\n  await p\n  if (PENDING === 0) PORT.unref()\n  consoleError('loader 1 : resolve : calling nextResolve', url)\n  return nextResolve(url, context)\n}\n"]}